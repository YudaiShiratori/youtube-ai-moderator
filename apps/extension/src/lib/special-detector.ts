import { DetectionResult, Category } from '../types';

/**
 * ç‰¹åˆ¥æ æ¤œå‡ºãƒ­ã‚¸ãƒƒã‚¯ - ä¸å€«é–¢é€£
 * ç‹¬ç«‹ã—ãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ã—ã¦åˆ†é›¢ç®¡ç†
 */
export class SpecialCategoryDetector {
  /**
   * ç‰¹åˆ¥ã‚«ãƒ†ã‚´ãƒªã®æ¤œå‡ºãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
   */
  detect(text: string, author: string): DetectionResult {
    const normalized = this.normalizeText(text);
    
    // ä¸å€«é–¢é€£ã®æ¤œå‡º
    const scandalResult = this.detectScandalContent(normalized);
    if (scandalResult.blocked) return scandalResult;

    return { blocked: false, category: null, reason: '' };
  }

  private normalizeText(text: string): string {
    // Unicode NFKCæ­£è¦åŒ–
    let normalized = text.normalize('NFKC');
    
    // ã‚¼ãƒ­å¹…ãƒ»çµåˆæ–‡å­—å‰Šé™¤
    normalized = normalized.replace(/[\u200B-\u200F\u202A-\u202E\u2066-\u2069\uFEFF]/g, '');
    
    // confusables/å…¨è§’è‹±æ•°ã®æ­£è¦åŒ–
    const charMap: Record<string, string> = {
      // ã‚­ãƒªãƒ«æ–‡å­—
      'Ğ°': 'a', 'Ğµ': 'e', 'Ğ¾': 'o', 'Ñ€': 'p', 'Ñ': 'c', 'Ñ…': 'x', 'Ñƒ': 'y', 'Ñ‚': 't',
      // å…¨è§’è‹±æ•°
      'ï½': 'a', 'ï½‚': 'b', 'ï½ƒ': 'c', 'ï½„': 'd', 'ï½…': 'e', 'ï½†': 'f',
      'ï½‡': 'g', 'ï½ˆ': 'h', 'ï½‰': 'i', 'ï½Š': 'j', 'ï½‹': 'k', 'ï½Œ': 'l',
      'ï½': 'm', 'ï½': 'n', 'ï½': 'o', 'ï½': 'p', 'ï½‘': 'q', 'ï½’': 'r',
      'ï½“': 's', 'ï½”': 't', 'ï½•': 'u', 'ï½–': 'v', 'ï½—': 'w', 'ï½˜': 'x',
      'ï½™': 'y', 'ï½š': 'z',
      'ï¼': '0', 'ï¼‘': '1', 'ï¼’': '2', 'ï¼“': '3', 'ï¼”': '4',
      'ï¼•': '5', 'ï¼–': '6', 'ï¼—': '7', 'ï¼˜': '8', 'ï¼™': '9',
    };
    
    for (const [from, to] of Object.entries(charMap)) {
      normalized = normalized.replace(new RegExp(from, 'gi'), to);
    }
    
    return normalized.toLowerCase();
  }

  /**
   * ä¸å€«ãƒ»ã‚¹ã‚­ãƒ£ãƒ³ãƒ€ãƒ«é–¢é€£ã®æ¤œå‡º
   */
  private detectScandalContent(text: string): DetectionResult {
    const scandalType = this.analyzeScandalPattern(text);
    
    if (scandalType === 'moral_attack') {
      return { blocked: true, category: 'backseat' as Category, reason: 'é“å¾³çš„æ”»æ’ƒ' };
    }
    
    if (scandalType === 'relationship_shaming') {
      return { blocked: true, category: 'backseat' as Category, reason: 'é–¢ä¿‚æ€§æ‰¹åˆ¤' };
    }
    
    if (scandalType === 'social_punishment') {
      return { blocked: true, category: 'backseat' as Category, reason: 'ç¤¾ä¼šçš„åˆ¶è£' };
    }

    return { blocked: false, category: null, reason: '' };
  }

  /**
   * ã‚¹ã‚­ãƒ£ãƒ³ãƒ€ãƒ«é–¢é€£ãƒ‘ã‚¿ãƒ¼ãƒ³ã®åˆ†æ
   */
  private analyzeScandalPattern(text: string): 'moral_attack' | 'relationship_shaming' | 'social_punishment' | 'none' {
    // 1. é“å¾³çš„æ”»æ’ƒãƒ‘ã‚¿ãƒ¼ãƒ³
    const moralAttackPatterns = [
      // ã‚¹ã‚­ãƒ£ãƒ³ãƒ€ãƒ«é–¢é€£ã®æ”»æ’ƒçš„è¨€åŠ
      /(?:ä¸å€«|æµ®æ°—|è£åˆ‡ã‚Š|äºŒè‚¡|Wä¸å€«).{0,30}(?:ã—ã¦ãŸ|ã—ãŸ|ç›¸æ‰‹|é‡éƒ|å¥³|ç”·|ãƒãƒ¬|ç™ºè¦š)/,
      // é“å¾³è¦³å¿µã«ã‚ˆã‚‹æ”»æ’ƒ
      /(?:å€«ç†|é“å¾³|å¸¸è­˜)(?:ãŒ|ã‚‚)(?:ãªã„|ç„¡ã„|æ¬ ã‘ã¦|ã‚¼ãƒ­|çš†ç„¡)/,
      // è²¬ä»»è¿½åŠ
      /(?:è²¬ä»»|ã‘ã˜ã‚)(?:ã‚’|ã‚‚)(?:å–ã‚Œ|ã¨ã‚Œ|æœãŸã›|ã¯ãŸã›)(?:ã‚ˆ|ï¼|$)/,
      // æ€§çš„ç¤ºå”†ãƒ»å˜²ç¬‘
      /(?:ã‚„ã£ãŸ|ã°ã£ã“ã‚Š|ãƒ ãƒ•ãƒ•|ã©ã‚“ãªå£°|ã“ã®å¾Œ).{0,15}(?:ã‚“ã§ã™|ã§ã™ã‹|ã‚“ã ã‚ã†|ã ã‚ã†ãª)ï¼Ÿ?/,
      // å˜²ç¬‘ãƒ»èŒ¶åŒ–ã—
      /(?:ã‚¦ã‚±ã‚‹|è‰|ç¬‘|w|ï½—).{0,20}(?:ä¸å€«|æµ®æ°—|ãƒãƒ¬|ç™ºè¦š|ã‚¹ã‚­ãƒ£ãƒ³ãƒ€ãƒ«)/
    ];

    if (moralAttackPatterns.some(pattern => pattern.test(text))) {
      return 'moral_attack';
    }

    // 2. é–¢ä¿‚æ€§æ¥è¾±æ”»æ’ƒãƒ‘ã‚¿ãƒ¼ãƒ³
    const relationshipShamingPatterns = [
      // é…å¶è€…ãƒ»æ‹äººã¸ã®åŒæƒ…ç…½ã‚Š
      /(?:å¥¥ã•ã‚“|æ—¦é‚£|å«|å¦»|å¤«|å½¼å¥³|å½¼æ°)(?:ãŒ|ã‚‚)(?:å¯å“€æƒ³|ã‹ã‚ã„ãã†|æ°—ã®æ¯’)/,
      // å­ä¾›ã¸ã®å½±éŸ¿è¨€åŠ
      /(?:å­ä¾›|ã“ã©ã‚‚|å­ã©ã‚‚)(?:ãŒ|ã‚‚|ã®)(?:å¯å“€æƒ³|å‚·ã¤ã|ãƒˆãƒ©ã‚¦ãƒ|å½±éŸ¿)/,
      // æ‹æ„›ãƒ»çµå©šè¦³æ‰¹åˆ¤
      /(?:çµå©š|æ‹æ„›|æ„›)(?:ã™ã‚‹|ã®)(?:è³‡æ ¼|æ¨©åˆ©)(?:ãŒ|ã‚‚)(?:ãªã„|ç„¡ã„)/,
      // å«Œæ‚ªãƒ»æ‹’çµ¶è¡¨ç¾
      /(?:ã†ã‚ã|ã‚‚ã†ã‚€ã‚Š|ã‚‚ã†ç„¡ç†|è¦‹ãŸããªã„|èããŸããªã„)(?:ã |ã§ã™|ã€‚|ï¼)/,
      // é–¢ä¿‚æ¨æ¸¬ãƒ»è©®ç´¢
      /(?:ãã°ã«ç”·|ä¸€ç·’ã«|ï¼’äººã§|2äººã§)(?:ã„ã‚‹|è¡Œã£ã¦|æ³Šã¾ã£ã¦)(?:ãŸ|ã‚‹)(?:ã‚“ã§ã™|ã®ã‹|ã¨æ€ã†)ï¼Ÿ?/
    ];

    if (relationshipShamingPatterns.some(pattern => pattern.test(text))) {
      return 'relationship_shaming';
    }

    // 3. ç¤¾ä¼šçš„åˆ¶è£è¦æ±‚ãƒ‘ã‚¿ãƒ¼ãƒ³
    const socialPunishmentPatterns = [
      // è·æ¥­ãƒ»åœ°ä½å‰¥å¥ªè¦æ±‚
      /(?:ä»•äº‹|è·|åœ°ä½|ç«‹å ´)(?:ã‚’|ã‚‚)(?:è¾ã‚ã‚|ã‚„ã‚ã‚|å¤±ãˆ|ã†ã—ãªãˆ|å¥ªã‚ã‚Œã‚)/,
      // ç¤¾ä¼šå¾©å¸°é˜»æ­¢
      /(?:äºŒåº¦ã¨|ã‚‚ã†)(?:è¡¨èˆå°|ãƒ¡ãƒ‡ã‚£ã‚¢|ãƒ†ãƒ¬ãƒ“|é…ä¿¡)(?:ã«|ã«ã¯)(?:å‡ºã‚‹ãª|ã§ã‚‹ãª|ç¾ã‚Œã‚‹ãª)/,
      // åˆ¶è£ãƒ»å ±å¾©äºˆå‘Š
      /(?:å ±ã„|ãƒãƒ|å¤©ç½°|åˆ¶è£)(?:ãŒ|ã‚’)(?:å½“ãŸã‚‹|å—ã‘ã‚‹|ä¸‹ã‚‹|é£Ÿã‚‰ã†)/,
      // è¿½æ”¾ãƒ»æ’é™¤è¦æ±‚
      /(?:è¿½æ”¾|æ’é™¤|é™¤å|æ°¸ä¹…è¿½æ”¾)(?:ã—ã‚|ã•ã‚Œã‚|ã™ã¹ã|ã™ã¹ãã )/
    ];

    if (socialPunishmentPatterns.some(pattern => pattern.test(text))) {
      return 'social_punishment';
    }

    // 4. ã‚¹ã‚­ãƒ£ãƒ³ãƒ€ãƒ«é–¢é€£ã®å˜ç´”è¨€åŠï¼ˆåºƒç¯„å›²æ¤œå‡ºï¼‰
    const scandalMentions = [
      // ã‚¹ã‚­ãƒ£ãƒ³ãƒ€ãƒ«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ç›´æ¥è¨€åŠ
      /(?:ä¸å€«|æµ®æ°—|äºŒè‚¡|Wä¸å€«)(?:ã—ã¦ãŸ|ã—ãŸ|ç›¸æ‰‹|ã—ã¦ã‚‹|ã |ã§ã™|ã§ã—ã‚‡ã†|ã‹ã‚ˆ|ã§ã™ã­)/,
      // ã‚¹ã‚­ãƒ£ãƒ³ãƒ€ãƒ« + å ´æ‰€ãƒ»çŠ¶æ³
      /(?:ä¸å€«|æµ®æ°—|ã‚¹ã‚­ãƒ£ãƒ³ãƒ€ãƒ«)(?:æ—…è¡Œ|å®¿æ³Š|ãƒ›ãƒ†ãƒ«|æ¸©æ³‰|ãƒ‡ãƒ¼ãƒˆ|ç¾å ´|å ´æ‰€)/,
      // ã‚¹ã‚­ãƒ£ãƒ³ãƒ€ãƒ« + æ„Ÿæƒ…è¡¨ç¾ï¼ˆè·é›¢æ‹¡å¼µï¼‰
      /(?:ä¸å€«|æµ®æ°—).{0,30}(?:ğŸ˜‚|w|ï½—|è‰|ç¬‘|ã‚¦ã‚±ã‚‹|ã†ã‘ã‚‹)/,
      // ã‚¹ã‚­ãƒ£ãƒ³ãƒ€ãƒ« + ã‚¢ãƒ‰ãƒã‚¤ã‚¹ãƒ»æ‰¹åˆ¤
      /(?:ä¸å€«|æµ®æ°—).{0,20}(?:ã‚„ã‚ãŸæ–¹ãŒ|ã‚„ã‚ãŸã»ã†ãŒ|ãƒ€ãƒ¡|ã ã‚|è‰¯ããªã„|ã‚ˆããªã„)/,
      // æ€§çš„ç¤ºå”†ï¼ˆæ‹¡å¼µç‰ˆï¼‰
      /(?:ã“ã®å¾Œ|ã‚ã®å¾Œ|å¤œã¯|ãƒ™ãƒƒãƒ‰ã§|ã“ã“ã§)(?:ã‚„ã£ãŸ|ã—ãŸ|ãƒ ãƒ•ãƒ•|ã‚¨ãƒƒãƒ|ã‚»ãƒƒã‚¯ã‚¹|ã°ã£ã“ã‚Š)/,
      // ãƒãƒ¬ãŸãƒ»ç™ºè¦šç³»
      /(?:ä¸å€«|æµ®æ°—)(?:ãŒ|ã‚‚).{0,20}(?:ãƒãƒ¬|ã°ã‚Œ|ç™ºè¦š|åˆ¤æ˜|éœ²å‘ˆ)/,
      // é‡‘éŠ­é–¢ä¿‚ã®ç¤ºå”†
      /(?:ãƒ›ãƒ†ãƒ«ä»£|å®¿æ³Šè²»|æ—…è¡Œä»£|ãŠé‡‘)(?:ã‚’|ã‚‚|ã¯).{0,15}(?:å‡ºã—ã¦|æ‰•ã£ã¦|ã‚‚ã‚‰ã£ãŸ|ãã‚ŒãŸ)/
    ];

    if (scandalMentions.some(pattern => pattern.test(text))) {
      return 'moral_attack';
    }

    return 'none';
  }
}

export const specialDetector = new SpecialCategoryDetector();