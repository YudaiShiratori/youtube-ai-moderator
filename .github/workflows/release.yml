name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Build extension
        run: bun run --filter @youtube-ai-moderator/extension build
      
      - name: Create extension zip
        run: |
          cd apps/extension
          bun zip
          cd ../..
      
      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false
      
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./apps/extension/youtube-ai-moderator.zip
          asset_name: youtube-ai-moderator-${{ github.ref_name }}.zip
          asset_content_type: application/zip

  # Chrome Web Store自動アップロード（オプション）
  # chrome-web-store-upload:
  #   runs-on: ubuntu-latest
  #   needs: build-and-release
  #   
  #   steps:
  #     - uses: actions/checkout@v4
  #     
  #     - uses: oven-sh/setup-bun@v1
  #       with:
  #         bun-version: latest
  #     
  #     - name: Install dependencies
  #       run: bun install --frozen-lockfile
  #     
  #     - name: Build extension
  #       run: bun run --filter @youtube-ai-moderator/extension build
  #     
  #     - name: Upload to Chrome Web Store
  #       run: |
  #         npx chrome-webstore-upload-cli@2 upload \
  #           --source apps/extension/dist \
  #           --extension-id ${{ secrets.CHROME_EXTENSION_ID }} \
  #           --client-id ${{ secrets.CHROME_CLIENT_ID }} \
  #           --client-secret ${{ secrets.CHROME_CLIENT_SECRET }} \
  #           --refresh-token ${{ secrets.CHROME_REFRESH_TOKEN }}